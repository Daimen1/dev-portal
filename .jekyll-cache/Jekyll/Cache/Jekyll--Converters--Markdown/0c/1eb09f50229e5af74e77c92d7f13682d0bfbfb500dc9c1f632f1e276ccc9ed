I"z<p><code class="highlighter-rouge">snetd</code>, the SingularityNET daemon, provides an API to call service methods using <a href="/docs/concepts/multi-party-escrow">multi-party escrow contract</a> payment channels.</p>

<p>To call a published service’s method, the client sends payment details via gRPC metadata, as described in the section <a href="#grpc-metadata">gRPC metadata</a>. The server will return one of the <a href="#grpc-error-codes">gRPC error codes</a> in response.</p>

<p>There are two situations where the client may want to get the payment channel state from the service: an <code class="highlighter-rouge">IncorrectNonce</code> in response, or when starting an service interaction for the first time. The payment channel state can be retrieved via the <a href="#payment-channel-state-api">payment channel state API</a>.</p>

<p>A sequence diagram of a typical client/service interaction can be found in the <a href="#sequence-of-calls">Sequence of Calls</a> section.</p>

<h2 id="grpc-metadata">gRPC metadata</h2>

<p>To pass payment data to the server when making a request, the client fills in the following gRPC metadata fields:</p>

<ul>
  <li><code class="highlighter-rouge">snet-payment-type</code> - payment protocol type; currently “escrow” is the only supported value, it means that MultiPartyEscrow (MPE) contract is used for payments;</li>
  <li><code class="highlighter-rouge">snet-payment-channel-id</code> - id of the payment channel in MPE contract (<a href="#using-decimal-numbers">decimal number string</a>)</li>
  <li><code class="highlighter-rouge">snet-payment-channel-nonce</code> - nonce of the payment channel (<a href="#using-decimal-numbers">decimal number string</a>)</li>
  <li><code class="highlighter-rouge">snet-payment-channel-amount</code> - payment amount authorized by the client (<a href="#using-decimal-numbers">decimal number string</a>)</li>
  <li><code class="highlighter-rouge">snet-payment-channel-signature-bin</code> - client payment signature (<a href="#binary-data-encoding">65 bytes in base64</a>)</li>
</ul>

<h3 id="using-decimal-numbers">Using decimal numbers</h3>

<p>Some values are represented as decimal numbers printed to a string. The reason is that by their nature, these values are incremental counters. Representing them as <code class="highlighter-rouge">uint256</code> value in hex string requires sending 64 bytes for a relatively small value. To make the representation more compact and clear, we have decided to keep them as decimal number represented as strings. The client should expect that this number can be as big as <code class="highlighter-rouge">uint256</code>, so the best type to represent such values in code is <code class="highlighter-rouge">BigInteger</code>.</p>

<h3 id="binary-data-encoding">Binary data encoding</h3>

<p>gRPC supports sending binary data in metadata fields. To use this feature, the metadata key should have a <code class="highlighter-rouge">-bin</code> postfix. The caller should pass values for such keys as a byte array casted to string (some implementations may allow passing byte arrays without casting). The gRPC library encodes such values using <code class="highlighter-rouge">base64</code>. <a href="https://github.com/grpc/grpc-go/blob/master/Documentation/grpc-metadata.md#storing-binary-data-in-metadata">Click to see what the gRPC documentation says about this for reference</a>.</p>

<h2 id="grpc-error-codes">gRPC error codes</h2>

<p>The SingularityNET daemon uses both standard and custom gRPC error codes to provide client with information when an error occurrs. In the case that the service itself returns an error, it will be passed to the client without transformation.</p>

<p>gRPC error codes:</p>
<ul>
  <li><code class="highlighter-rouge">Unauthenticated</code> - payment details are incorrect;</li>
  <li><code class="highlighter-rouge">IncorrectNonce</code> (custom code <strong>1000</strong>) - payment nonce is incorrect, possible
reason is that service provider claimed funds and incremented the channel nonce;</li>
  <li><code class="highlighter-rouge">FailedPrecondition</code> - call cannot be done because another call is in progress
or rate restriction is applied;</li>
  <li><code class="highlighter-rouge">InvalidArgument</code> - payment details format is incorrect;</li>
  <li><code class="highlighter-rouge">Internal</code> - unexpected error, daemon state is incorrect or some subsystem is
unavailable, the service provider needs to resolve the issue;</li>
</ul>

<p>Full list of expected error messages:</p>
<ul>
  <li><code class="highlighter-rouge">Unauthenticated</code>:
    <ul>
      <li>“payment signature is not valid”</li>
      <li>“payment is not signed by channel signer”</li>
      <li>“payment channel is near to be expired, expiration time: %v, current block: %v, expiration threshold: %v”</li>
      <li>“not enough tokens on payment channel, channel amount: %v, payment amount: %v”</li>
      <li>“payment channel "%v" not found”</li>
      <li>“income %d does not equal to price %d”</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">IncorrectNonce</code>:
    <ul>
      <li>“incorrect payment channel nonce, latest: %v, sent: %v”</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">FailedPrecondition</code>:
    <ul>
      <li>“another transaction on channel: %v is in progress”</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">InvalidArgument</code>:
    <ul>
      <li>“missing metadata”</li>
      <li>“unexpected "snet-payment-type", value: "%v"”</li>
      <li>“incorrect format "%v": "%v"”</li>
      <li>“incorrect binary key name "%v"”</li>
      <li>“missing "%v"”</li>
      <li>“too many values for key "%v": %v”</li>
    </ul>
  </li>
</ul>

<h2 id="payment-channel-state-api">Payment Channel State API</h2>

<p>The client can get the latest payment channel state from the service using PaymentChannelStateService via gRPC. See <a href="https://github.com/singnet/snet-daemon/blob/master/escrow/state_service.proto">state_service.proto</a> for the API description.</p>

<h2 id="sequence-of-calls">Sequence of Calls</h2>

<p>Sequence diagram of calls during client/daemon interaction:
<a href="/assets/img/mpe/clientDaemonInteractionSequenceDiagram.svg"><img src="/assets/img/mpe/clientDaemonInteractionSequenceDiagram.svg" alt="Client/daemon interaction sequence diagram" title="Client/daemon interaction sequence diagram" /></a></p>
:ET